<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Control Center - Live</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #3b82f6; --purple: #a855f7; --dark: #1e293b; --bg: #f8fafc; --green: #22c55e; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--dark); }
        .container { max-width: 1150px; margin: auto; animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid var(--blue); padding-bottom: 15px; }
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 30px; border: 1px solid rgba(0,0,0,0.02); }
        .card-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; color: var(--blue); display: flex; align-items: center; gap: 10px; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #f1f5f9; color: #64748b; font-size: 12px; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }

        /* Live Status Pulse */
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .online { background-color: var(--green); box-shadow: 0 0 8px var(--green); animation: pulse 1.5s infinite; }
        .offline { background-color: #cbd5e1; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .student { background: #dcfce7; color: #166534; }
        .faculty { background: #fef9c3; color: #854d0e; }
        .type-usage { background: #eff6ff; color: #1d4ed8; }
        .type-reading { background: #f5f3ff; color: #6d28d9; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="admin-panel" class="container hidden">
    <div class="admin-header">
        <h1>Library Admin Center</h1>
        <div style="text-align: right;">
            <span id="live-count" style="font-weight: bold; color: var(--green);">0 Students Online</span><br>
            <small style="color: #94a3b8;">Refreshing every 30s</small>
        </div>
    </div>

    <div class="card">
        <div class="card-title">üë• Member Management & Live Status</div>
        <table id="userTable">
            <thead>
                <tr><th>Status</th><th>Name</th><th>Email</th><th>Institution</th><th>Position</th><th>WhatsApp</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="card">
        <div class="card-title">‚è≥ Student Activity Logs</div>
        <table id="logTable">
            <thead>
                <tr><th>Student</th><th>Activity Type</th><th>Duration</th><th>Date & Time</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="denied" class="container hidden" style="text-align: center; margin-top: 100px;">
    <h1>üö´ Access Denied</h1>
    <p>Restricted to <b>phlagongkk@gmail.com</b></p>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBBZ5Yvd7XH4lymNq2vIp-cwxPba55upWg",
      authDomain: "student-library-4a4e7.firebaseapp.com",
      projectId: "student-library-4a4e7",
      storageBucket: "student-library-4a4e7.firebasestorage.app",
      messagingSenderId: "827419448917",
      appId: "1:827419448917:web:4b0d1084e6f1fe1b2566dc"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const ADMIN_EMAIL = "phlagongkk@gmail.com";

    auth.onAuthStateChanged(async (user) => {
        if (user && user.email === ADMIN_EMAIL) {
            document.getElementById('admin-panel').classList.remove('hidden');
            loadAllData();
            // Refresh live status every 30 seconds
            setInterval(loadAllData, 30000);
        } else {
            document.getElementById('denied').classList.remove('hidden');
        }
    });

    async function loadAllData() {
        const userSnap = await db.collection("users").get();
        const userTbody = document.querySelector("#userTable tbody");
        userTbody.innerHTML = "";
        let onlineCount = 0;

        userSnap.forEach(doc => {
            const u = doc.data();
            const now = Date.now();
            const lastActive = u.lastActive ? new Date(u.lastActive).getTime() : 0;
            // If active in last 3 minutes, show as Online
            const isOnline = (now - lastActive) < 180000; 
            if(isOnline) onlineCount++;

            userTbody.innerHTML += `
                <tr>
                    <td>
                        <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
                        <small>${isOnline ? 'Online' : 'Offline'}</small>
                    </td>
                    <td><b>${u.fullName}</b></td>
                    <td>${u.email}</td>
                    <td>${u.institution}</td>
                    <td><span class="badge ${u.position}">${u.position}</span></td>
                    <td>${u.whatsapp || 'N/A'}</td>
                </tr>
            `;
        });
        document.getElementById('live-count').innerText = `${onlineCount} Students Online`;

        const logSnap = await db.collection("activity_logs").orderBy("timestamp", "desc").limit(30).get();
        const logTbody = document.querySelector("#logTable tbody");
        logTbody.innerHTML = "";
        logSnap.forEach(doc => {
            const l = doc.data();
            const typeClass = l.activityType.includes("Usage") ? "type-usage" : "type-reading";
            logTbody.innerHTML += `
                <tr>
                    <td>${l.userName}</td>
                    <td><span class="badge ${typeClass}">${l.activityType}</span></td>
                    <td><b>${l.duration}</b></td>
                    <td style="color: #94a3b8; font-size: 12px;">${new Date(l.timestamp).toLocaleString()}</td>
                </tr>
            `;
        });
    }
</script>
</body>
</html>
