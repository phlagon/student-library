<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Admin - Master Control</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #3b82f6; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); padding: 20px; color: #1e293b; }
        .card { background: var(--card); border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; background: #e2e8f0; }
        .tab-btn.active { background: var(--blue); color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; font-size: 11px; text-transform: uppercase; color: #64748b; padding: 10px; border-bottom: 2px solid #f1f5f9; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .btn-sm { padding: 6px 12px; border-radius: 8px; border: none; font-size: 11px; cursor: pointer; font-weight: 600; margin: 2px; }
        input, select { padding: 10px; border-radius: 10px; border: 1px solid #ddd; width: 100%; margin-bottom: 10px; box-sizing: border-box; }
        .hidden { display: none !important; }
        .badge { padding: 4px 8px; border-radius: 5px; font-size: 10px; font-weight: bold; }
        .online { background: #dcfce7; color: #166534; }
    </style>
</head>
<body>

    <div class="nav-tabs">
        <button id="t-inv" class="tab-btn active" onclick="switchTab('inv')">PDF Inventory</button>
        <button id="t-mem" class="tab-btn" onclick="switchTab('mem')">Members & Activity</button>
    </div>

    <div id="inv-section" class="card">
        <h2>üìÇ Global PDF Inventory</h2>
        <div style="background: #f1f5f9; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
            <h4>Register New Uploaded PDF</h4>
            <input type="text" id="reg-id" placeholder="File Name (e.g., science)">
            <input type="text" id="reg-title" placeholder="Display Title">
            <select id="reg-cat">
                <option value="Systematic Theology">Systematic Theology</option>
                <option value="CHURCH History">CHURCH History</option>
                <option value="Mission">Mission</option>
                <option value="Acts of Apostles">Acts of Apostles</option>
                <option value="Synoptic Gospel">Synoptic Gospel</option>
                <option value="Introduction to BIBLE">Introduction to BIBLE</option>
            </select>
            <button class="btn-sm" style="background: var(--blue); color: white; width: 100%; padding: 12px;" onclick="registerPDF()">Save to Inventory</button>
        </div>
        <table>
            <thead><tr><th>PDF File</th><th>Category</th><th>Promotions</th><th>Action</th></tr></thead>
            <tbody id="inventory-list"></tbody>
        </table>
    </div>

    <div id="mem-section" class="hidden">
        <div class="card">
            <h3>üë• Member Live Status</h3>
            <table id="memberTable">
                <thead><tr><th>Status</th><th>Name</th><th>Email</th><th>Institution</th></tr></thead>
                <tbody id="member-body"></tbody>
            </table>
        </div>
        <div class="card">
            <h3>‚è≥ Student Activity Logs</h3>
            <table id="logTable">
                <thead><tr><th>Student</th><th>Activity</th><th>Time</th></tr></thead>
                <tbody id="log-body"></tbody>
            </table>
        </div>
    </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBBZ5Yvd7XH4lymNq2vIp-cwxPba55upWg",
      authDomain: "student-library-4a4e7.firebaseapp.com",
      projectId: "student-library-4a4e7",
      storageBucket: "student-library-4a4e7.firebasestorage.app",
      messagingSenderId: "827419448917",
      appId: "1:827419448917:web:4b0d1084e6f1fe1b2566dc"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function switchTab(t) {
        document.getElementById('inv-section').classList.toggle('hidden', t !== 'inv');
        document.getElementById('mem-section').classList.toggle('hidden', t !== 'mem');
        document.getElementById('t-inv').classList.toggle('active', t === 'inv');
        document.getElementById('t-mem').classList.toggle('active', t === 'mem');
    }

    async function registerPDF() {
        const id = document.getElementById('reg-id').value.trim();
        const title = document.getElementById('reg-title').value.trim();
        const cat = document.getElementById('reg-cat').value;
        if(!id || !title) return alert("Fill all fields");
        await db.collection("library_settings").doc(id).set({ title, category: cat, updatedAt: new Date().toISOString() }, { merge: true });
        location.reload();
    }

    db.collection("library_settings").onSnapshot(snap => {
        const list = document.getElementById('inventory-list');
        list.innerHTML = "";
        snap.forEach(doc => {
            const b = doc.data();
            list.innerHTML += `<tr>
                <td><b>${b.title || doc.id}</b><br><small>${doc.id}.pdf</small></td>
                <td><span style="color:var(--blue)">${b.category || 'Uncategorized'}</span></td>
                <td>
                    <button class="btn-sm" style="background:#dcfce7" onclick="updatePromo('${doc.id}', 'recent', 5)">+ Recent</button>
                    <button class="btn-sm" style="background:#fef9c3" onclick="updatePromo('${doc.id}', 'trending', 10)">+ Trend</button>
                </td>
                <td><button class="btn-sm" style="background:#fee2e2" onclick="deleteBook('${doc.id}')">Delete</button></td>
            </tr>`;
        });
    });

    db.collection("users").onSnapshot(snap => {
        const tbody = document.getElementById('member-body');
        tbody.innerHTML = "";
        snap.forEach(doc => {
            const u = doc.data();
            const isOnline = (Date.now() - new Date(u.lastActive).getTime()) < 180000;
            tbody.innerHTML += `<tr>
                <td><span class="badge ${isOnline?'online':''}">‚óè ${isOnline?'Online':'Offline'}</span></td>
                <td>${u.fullName}</td><td>${u.email}</td><td>${u.institution || 'N/A'}</td>
            </tr>`;
        });
    });

    db.collection("activity_logs").orderBy("timestamp", "desc").limit(15).onSnapshot(snap => {
        const tbody = document.getElementById('log-body');
        tbody.innerHTML = "";
        snap.forEach(doc => {
            const l = doc.data();
            tbody.innerHTML += `<tr><td>${l.userName}</td><td>${l.activityType}</td><td>${new Date(l.timestamp).toLocaleString()}</td></tr>`;
        });
    });

    async function updatePromo(id, cat, limit) {
        const snap = await db.collection("library_settings").where(cat, "==", true).get();
        if(snap.size >= limit) {
            let oldestDoc = snap.docs[0].id;
            await db.collection("library_settings").doc(oldestDoc).update({ [cat]: false });
        }
        await db.collection("library_settings").doc(id).update({ [cat]: true, updatedAt: new Date().toISOString() });
    }

    async function deleteBook(id) { if(confirm("Delete this?")) await db.collection("library_settings").doc(id).delete(); }
</script>
</body>
</html>
