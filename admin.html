<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Control Center - Precise Logs</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #3b82f6; --purple: #a855f7; --bg: #f8fafc; --dark: #1e293b; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--dark); }
        .container { max-width: 1200px; margin: auto; }
        .hidden { display: none !important; }
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); padding: 25px; margin-bottom: 25px; }
        .card-header { font-weight: 600; color: var(--blue); border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: #64748b; font-size: 11px; text-transform: uppercase; background: #f8fafc; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .clickable-row { cursor: pointer; transition: 0.2s; }
        .clickable-row:hover { background: #eff6ff; }
        #user-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .modal { background: white; width: 95%; max-width: 900px; height: 85vh; border-radius: 30px; overflow-y: auto; padding: 30px; position: relative; }
        .close-btn { position: absolute; top: 20px; right: 20px; background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 10px; cursor: pointer; }
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .folder { padding: 20px; border-radius: 15px; background: #f8fafc; border: 2px solid #e2e8f0; cursor: pointer; text-align: center; }
        .folder:hover { border-color: var(--blue); background: white; }
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .online { background: #dcfce7; color: #166534; }
        .offline { background: #f1f5f9; color: #64748b; }
        .status-returned { color: #22c55e; font-weight: bold; }
        .status-active { color: #ef4444; font-weight: bold; }
    </style>
</head>
<body>

<div id="admin-main" class="container">
    <div class="card">
        <div class="card-header">
            <span>ðŸ‘¥ Registered Members</span>
            <small id="live-indicator">Real-time Dashboard</small>
        </div>
        <table id="memberTable">
            <thead>
                <tr><th>Status</th><th>Name</th><th>Email</th><th>Institution</th><th>Action</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="user-overlay" class="hidden">
    <div class="modal">
        <button class="close-btn" onclick="closeUserDetail()">Close</button>
        <h2 id="m-user-name">User Details</h2>
        <p id="m-user-email" style="color: #64748b; margin-top:-10px;"></p>

        <div class="folder-grid">
            <div class="folder" onclick="showSubDetail('app-timings')">ðŸ“‚ <h4>App Usage Timings</h4></div>
            <div class="folder" onclick="showSubDetail('borrowed-books')">ðŸ“‚ <h4>Borrowed Books</h4></div>
            <div class="folder" onclick="showSubDetail('borrow-codes')">ðŸ“‚ <h4>Borrow Code</h4></div>
        </div>

        <div id="sub-detail-content" class="card" style="min-height: 300px;">
            <p style="text-align: center; color: #94a3b8;">Select a category above</p>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBBZ5Yvd7XH4lymNq2vIp-cwxPba55upWg",
      authDomain: "student-library-4a4e7.firebaseapp.com",
      projectId: "student-library-4a4e7",
      storageBucket: "student-library-4a4e7.firebasestorage.app",
      messagingSenderId: "827419448917",
      appId: "1:827419448917:web:4b0d1084e6f1fe1b2566dc"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let selectedUser = null;
    let userLogs = [];
    let userBorrows = [];

    auth.onAuthStateChanged(user => {
        if(user && user.email === "phlagongkk@gmail.com") { loadMembers(); }
        else { window.location.href = "index.html"; }
    });

    async function loadMembers() {
        const snap = await db.collection("users").get();
        const tbody = document.querySelector("#memberTable tbody");
        tbody.innerHTML = "";
        snap.forEach(doc => {
            const u = doc.data();
            const lastActive = u.lastActive ? new Date(u.lastActive).getTime() : 0;
            const isOnline = (Date.now() - lastActive) < 180000;
            const row = document.createElement('tr');
            row.className = "clickable-row";
            row.onclick = () => openUserDetail(u);
            row.innerHTML = `
                <td><span class="badge ${isOnline ? 'online' : 'offline'}">${isOnline ? 'Online' : 'Offline'}</span></td>
                <td><b>${u.fullName}</b></td>
                <td>${u.email}</td>
                <td>${u.institution || 'N/A'}</td>
                <td style="color: var(--blue); font-weight:600;">Open Folder â†’</td>
            `;
            tbody.appendChild(row);
        });
    }

    async function openUserDetail(user) {
        selectedUser = user;
        document.getElementById('m-user-name').innerText = user.fullName;
        document.getElementById('m-user-email').innerText = user.email;
        document.getElementById('user-overlay').classList.remove('hidden');
        document.getElementById('sub-detail-content').innerHTML = `<p style="text-align: center;">Loading folders...</p>`;

        const logSnap = await db.collection("activity_logs").where("userName", "==", user.fullName).orderBy("timestamp", "desc").get();
        userLogs = logSnap.docs.map(d => d.data());

        const borrowSnap = await db.collection("borrows").where("userId", "==", user.uid).get();
        userBorrows = borrowSnap.docs.map(d => d.data());
        
        showSubDetail('app-timings');
    }

    function showSubDetail(folder) {
        const content = document.getElementById('sub-detail-content');
        content.innerHTML = "";

        if(folder === 'app-timings') {
            let appSecs = 0, readSecs = 0, borrowReadSecs = 0;
            userLogs.forEach(l => {
                let parts = l.duration.match(/\d+/g);
                let s = parts ? (parseInt(parts[0])*60) + (parseInt(parts[1])||0) : 0;
                if(l.activityType === "Total App Usage") appSecs += s;
                else if(l.activityType.includes("Preview")) readSecs += s;
                else if(l.activityType.includes("Borrowed")) borrowReadSecs += s;
            });
            content.innerHTML = `
                <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                    <b>Total App Timing</b> <span>${Math.floor(appSecs/60)}m ${appSecs%60}s</span>
                </div>
                <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                    <b>Read Online Timing</b> <span>${Math.floor(readSecs/60)}m ${readSecs%60}s</span>
                </div>
                <div style="padding:10px; display:flex; justify-content:space-between;">
                    <b>Borrowed Books Reading Time</b> <span>${Math.floor(borrowReadSecs/60)}m ${borrowReadSecs%60}s</span>
                </div>
            `;
        } 
        else if(folder === 'borrowed-books') {
            let html = `<table><thead><tr><th>Book</th><th>Exact Borrow Time</th><th>Expected Return</th><th>Status</th></tr></thead><tbody>`;
            
            // Check current active borrows
            userBorrows.forEach(b => {
                const borrowTime = b.borrowedAt ? new Date(b.borrowedAt).toLocaleString() : "Old Record";
                html += `<tr>
                    <td>${b.title}</td>
                    <td>${borrowTime}</td>
                    <td>${new Date(b.expiresOn).toLocaleDateString()}</td>
                    <td class="status-active">Current (Active)</td>
                </tr>`;
            });

            // Check activity logs for "Returned" actions
            userLogs.filter(l => l.activityType.includes("Returned")).forEach(rl => {
                html += `<tr>
                    <td>${rl.activityType.replace("Returned: ", "")}</td>
                    <td>-</td>
                    <td>-</td>
                    <td class="status-returned">Returned on ${new Date(rl.timestamp).toLocaleDateString()}</td>
                </tr>`;
            });

            if(userBorrows.length === 0 && !html.includes("Returned")) {
                content.innerHTML = "<p style='text-align:center;'>No borrow history for this user.</p>";
            } else {
                content.innerHTML = html + "</tbody></table>";
            }
        }
        else if(folder === 'borrow-codes') {
            content.innerHTML = `<p><b>Main Access Code:</b> BORROW2026</p>`;
        }
    }

    function closeUserDetail() { document.getElementById('user-overlay').classList.add('hidden'); }
</script>
</body>
</html>
