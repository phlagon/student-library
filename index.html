<script>
/* ======================
   FIREBASE INIT
   ====================== */
const firebaseConfig = {
  apiKey: "AIzaSyBBZ5Yvd7XH4lymNq2vIp-cwxPba55upWg",
  authDomain: "student-library-4a4e7.firebaseapp.com",
  projectId: "student-library-4a4e7",
  storageBucket: "student-library-4a4e7.firebasestorage.app",
  messagingSenderId: "827419448917",
  appId: "1:827419448917:web:4b0d1084e6f1fe1b2566dc"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const auth = firebase.auth();

/* ======================
   GLOBAL STATE
   ====================== */
let allBooks = [];
let currentUser = null;
let sessionStart = null;
let readStart = null;
let readTask = "";

/* ======================
   SAFE CLOCK
   ====================== */
setInterval(() => {
    const c = document.getElementById('clock');
    if (c) c.innerText = new Date().toLocaleTimeString();
}, 1000);

/* =========================
   GOOGLE LOGIN (REDIRECT)
   NO POPUP BLOCKER ISSUES
   ========================= */
async function handleLogin() {
    const provider = new firebase.auth.GoogleAuthProvider();
    const s = document.getElementById('login-status');
    if (s) s.innerText = "Redirecting to Google login...";
    try {
        await auth.signInWithRedirect(provider);
    } catch (e) {
        console.error("Login Redirect Error:", e);
        if (s) s.innerText = "Unable to start login. Please try again.";
    }
}

/* ======================
   HANDLE REDIRECT RESULT
   ====================== */
auth.getRedirectResult()
  .then(() => {
      console.log("Redirect handled");
  })
  .catch(err => {
      console.error("Redirect Error:", err);
      const s = document.getElementById('login-status');
      if (s) s.innerText = "Login failed. Please try again.";
  });

/* ======================
   AUTH STATE
   ====================== */
auth.onAuthStateChanged(user => {
    const authScreen = document.getElementById('auth-screen');
    const dashboard = document.getElementById('dashboard');

    if (user) {
        currentUser = user;
        sessionStart = Date.now();

        if (authScreen) authScreen.classList.add('hidden');
        if (dashboard) dashboard.classList.remove('hidden');

        const pname = document.getElementById('p-name');
        if (pname) pname.innerText = user.displayName || "User";

        loadLib();
        listenBorrows();
        logAct("App Opened");

    } else {
        if (authScreen) authScreen.classList.remove('hidden');
        if (dashboard) dashboard.classList.add('hidden');
    }
});

/* ======================
   ACTIVITY LOG
   ====================== */
function logAct(type, dur = "0s") {
    if (!currentUser) return;

    db.collection("activity_logs").add({ 
        userId: currentUser.uid,
        activityType: type,
        duration: dur,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).catch(err => console.error("Log error:", err));
}

/* ======================
   PDF READER
   ====================== */
function openPdf(id, s, task) {
    readStart = Date.now();
    readTask = task || "Reading";

    const frame = document.getElementById('pdf-frame');
    const overlay = document.getElementById('reader-overlay');

    if (frame) frame.src = `public/${id}${s}.pdf#toolbar=0`;
    if (overlay) overlay.classList.remove('hidden');
}

function closeReader() {
    if (readStart) {
        const dur = Math.round((Date.now() - readStart) / 1000)
