<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheoLib Command Center</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #3b82f6; --orange: #f97316; --green: #10b981; --red: #ef4444; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --border: #334155; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: start; }
        .card { background: var(--card); border-radius: 15px; padding: 20px; border: 1px solid var(--border); margin-bottom: 15px; }
        h2 { color: var(--blue); margin-top: 0; font-size: 16px; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        input, select, textarea { width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: white; box-sizing: border-box; font-size: 12px; font-family: inherit; }
        button { width: 100%; padding: 10px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; font-family: inherit; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-red { background: var(--red); color: white; width: auto; padding: 4px 8px; font-size: 10px; border-radius: 5px; }
        .btn-action { background: #334155; color: white; padding: 4px 8px; width: auto; font-size: 10px; border-radius: 5px; border: 1px solid var(--border); margin-right: 4px; }
        .btn-action.active { background: var(--green); border-color: var(--green); }
        .list-item { background: #161e2e; padding: 12px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border); font-size: 12px; cursor: pointer; }
        .scroll-area { max-height: 450px; overflow-y: auto; padding-right: 5px; }
        .hidden { display: none !important; }
        .breadcrumb { font-size: 11px; color: var(--blue); margin-bottom: 10px; cursor: pointer; }
        .multi-select-box { background: #0b1120; border: 1px solid var(--border); border-radius: 8px; padding: 10px; max-height: 80px; overflow-y: auto; margin-bottom: 10px; }
        .multi-option { display: flex; align-items: center; gap: 8px; font-size: 11px; margin-bottom: 4px; }
        .multi-option input { width: auto; margin: 0; }
        .control-row { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; align-items: center; }
        .tiny-select { width: auto; padding: 2px 5px; font-size: 10px; margin-bottom: 0; background: #1e293b; }
        .inbox-msg { border-left: 3px solid var(--orange); background: #161e2e; padding: 8px; margin-bottom: 8px; border-radius: 5px; font-size: 11px; position: relative; }
        .msg-del { position: absolute; right: 8px; top: 8px; color: var(--red); cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="auth-screen" style="position:fixed; inset:0; background:var(--bg); z-index:10000; display:flex; align-items:center; justify-content:center;">
        <div class="card" style="width:300px; text-align:center;">
            <h2 style="justify-content:center; margin-bottom:15px;">Admin Login</h2>
            <select id="admin-role-select"><option value="super">Super Admin</option><option value="college">College Admin</option></select>
            <input type="text" id="admin-id" placeholder="Admin ID">
            <input type="password" id="admin-pass" placeholder="Password">
            <button class="btn-blue" onclick="checkAuth()">Login</button>
        </div>
    </div>

    <div id="main-portal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h1 id="portal-title" style="font-size: 20px;">TheoLib Command Center</h1>
            <button onclick="location.reload()" style="width:auto; padding:6px 12px; background:var(--card); color:white; border:1px solid var(--border); font-size:12px;">üîÑ Sync System</button>
        </div>

        <div class="grid">
            <div>
                <div class="card" id="inventory-card">
                    <h2>üìö Inventory Management</h2>
                    <input type="text" id="b-title" placeholder="Book Title">
                    <input type="text" id="b-id" placeholder="Book ID (filename)">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                        <select id="b-cat"><option value="Theology">Theology</option><option value="Acts">Acts of Apostles</option><option value="Ethics">Ethics</option><option value="Church History">History</option><option value="Mission">Mission</option><option value="Bible Intro">Bible Intro</option><option value="Other Books">Other</option></select>
                        <select id="b-lang"><option value="English">English</option><option value="Tamil">Tamil</option><option value="Malayalam">Malayalam</option><option value="Hindi">Hindi</option></select>
                    </div>
                    <label style="font-size: 10px; color: var(--blue);">Target Colleges:</label>
                    <div class="multi-select-box" id="b-colls-list"></div>
                    <button class="btn-blue" onclick="addBook()">+ Add Book</button>
                </div>

                <div class="card" id="member-card">
                    <h2>üë• Member Management</h2>
                    <input type="text" id="m-name" placeholder="Full Name">
                    <div style="display:grid; grid-template-columns: 1.5fr 1fr; gap:8px;">
                        <select id="m-coll-select"><option value="">Select College</option></select>
                        <input type="text" id="m-coll-new" placeholder="OR New ID">
                    </div>
                    <input type="text" id="m-id" placeholder="User ID">
                    <input type="password" id="m-pass" placeholder="Password">
                    <select id="m-role"><option value="student">Student</option><option value="faculty">Faculty</option><option value="college_admin">College Admin</option></select>
                    <button class="btn-blue" style="background:var(--green);" onclick="addMember()">+ Register</button>
                </div>
            </div>

            <div>
                <div class="card">
                    <h2>‚è±Ô∏è Attendance Drill-Down</h2>
                    <div id="view-colleges"><div id="college-list-area" class="scroll-area"></div></div>
                    <div id="view-students" class="hidden"><div class="breadcrumb" onclick="showCollegesNav()">‚Üê Back to Colleges</div><div id="student-list-area" class="scroll-area"></div></div>
                    <div id="view-details" class="hidden">
                        <div class="breadcrumb" onclick="showStudentsNav()">‚Üê Back to Students</div>
                        <h3 id="det-name" style="font-size:14px; margin:0;"></h3>
                        <div id="det-summary" style="display:flex; flex-direction:column; background:#161e2e; padding:8px; border-radius:8px; font-size:11px; margin:10px 0; gap:5px;">
                            <div id="sum-usage">Usage: <b>0s</b></div>
                            <div id="sum-read">Read: <b>0s</b></div>
                        </div>
                        <button class="btn-blue" style="margin-bottom:10px; background:var(--green); font-size:10px;" onclick="downloadStudentCSV()">üìä Download Logs</button>
                        <div class="scroll-area" id="det-logs" style="font-size:10px;"></div>
                    </div>
                </div>
                <div class="card">
                    <h2>üìñ Inventory Controls</h2>
                    <div class="scroll-area" id="book-list"></div>
                </div>
                <div class="card">
                    <h2>üì• Global Inbox</h2>
                    <div class="scroll-area" id="inbox-area"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBBZ5Yvd7XH4lymNq2vIp-cwxPba55upWg", authDomain: "theolib.in", projectId: "student-library-4a4e7", storageBucket: "student-library-4a4e7.firebasestorage.app", messagingSenderId: "827419448917", appId: "1:827419448917:web:4b0d1084e6f1fe1b2566dc" };
        firebase.initializeApp(firebaseConfig); const db = firebase.firestore();

        let loggedInRole = ""; let loggedInCollege = ""; let collegeList = []; let allUsers = []; let currentLogs = []; let currentStudentName = "";

        async function checkAuth() { const role = document.getElementById('admin-role-select').value, id = document.getElementById('admin-id').value, pass = document.getElementById('admin-pass').value; if(role === 'super' && id === 'admin' && pass === 'theo777') { loggedInRole = "super"; startApp(); } else if (role === 'college') { const snap = await db.collection("users").where("studentId","==",id).where("password","==",pass).where("role","==","college_admin").get(); if(!snap.empty) { loggedInRole = "college"; loggedInCollege = snap.docs[0].data().collegeId; startApp(); } else alert("Invalid Credentials"); } else alert("Login Failed"); }
        function startApp() { document.getElementById('auth-screen').classList.add('hidden'); loadColleges(); loadBooks(); loadInbox(); loadAttendance(); }
        function loadColleges() { db.collection("users").onSnapshot(snap => { const colls = new Set(); snap.forEach(doc => { if(doc.data().collegeId) colls.add(doc.data().collegeId); }); collegeList = Array.from(colls); const select = document.getElementById('m-coll-select'), multi = document.getElementById('b-colls-list'); select.innerHTML = `<option value="">Select College</option>`; multi.innerHTML = ""; collegeList.forEach(c => { select.innerHTML += `<option value="${c}">${c}</option>`; multi.innerHTML += `<div class="multi-option"><input type="checkbox" name="target-colls" value="${c}"><span>${c}</span></div>`; }); }); }
        async function addBook() { const title = document.getElementById('b-title').value, id = document.getElementById('b-id').value, cat = document.getElementById('b-cat').value, lang = document.getElementById('b-lang').value; const selectedColls = Array.from(document.querySelectorAll('input[name="target-colls"]:checked')).map(cb => cb.value); if(!title || !id || selectedColls.length === 0) return alert("Fill all info!"); await db.collection("library_settings").doc(id).set({ title, category: cat, language: lang, allowedColleges: selectedColls, recent: true, promoted: false }); alert("Book Registered!"); }
        function loadBooks() { db.collection("library_settings").onSnapshot(snap => { const list = document.getElementById('book-list'); list.innerHTML = ""; snap.forEach(doc => { const b = doc.data(); const id = doc.id; list.innerHTML += `<div class="list-item" style="cursor:default"><div style="display:flex; justify-content:space-between;"><b>${b.title}</b> <button class="btn-red" onclick="deleteBook('${id}')">Del</button></div><div class="control-row"><select class="tiny-select" onchange="updateBook('${id}','language',this.value)"><option value="English" ${b.language=='English'?'selected':''}>English</option><option value="Tamil" ${b.language=='Tamil'?'selected':''}>Tamil</option><option value="Malayalam" ${b.language=='Malayalam'?'selected':''}>Malayalam</option></select><select class="tiny-select" onchange="updateBook('${id}','category',this.value)"><option value="Theology" ${b.category=='Theology'?'selected':''}>Theology</option><option value="Acts" ${b.category=='Acts'?'selected':''}>Acts</option><option value="Ethics" ${b.category=='Ethics'?'selected':''}>Ethics</option><option value="Mission" ${b.category=='Mission'?'selected':''}>Mission</option><option value="Church History" ${b.category=='Church History'?'selected':''}>History</option><option value="Bible Intro" ${b.category=='Bible Intro'?'selected':''}>Intro</option></select><button class="btn-action ${b.promoted?'active':''}" onclick="updateBook('${id}','promoted',${!b.promoted})">Promo</button><input type="text" class="tiny-select" style="width:70px" value="${b.allowedColleges.join(',')}" onchange="updateBook('${id}','allowedColleges',this.value.split(','))"></div></div>`; }); }); }
        async function updateBook(id, f, v) { await db.collection("library_settings").doc(id).update({ [f]: v }); }
        async function deleteBook(id) { if(confirm("Delete?")) await db.collection("library_settings").doc(id).delete(); }
        async function addMember() { const n = document.getElementById('m-name').value, c = document.getElementById('m-coll-new').value.toUpperCase() || document.getElementById('m-coll-select').value, i = document.getElementById('m-id').value, p = document.getElementById('m-pass').value, r = document.getElementById('m-role').value; if(!n || !c || !i) return alert("Fill info!"); await db.collection("users").add({ fullName: n, collegeId: c, studentId: i, password: p, role: r, lastActive: Date.now() }); alert("Registered!"); }

        function loadAttendance() {
            db.collection("users").onSnapshot(snap => {
                allUsers = []; const colls = new Set();
                snap.forEach(doc => { const u = {id: doc.id, ...doc.data()}; if(loggedInRole === 'college' && u.collegeId !== loggedInCollege) return; allUsers.push(u); colls.add(u.collegeId); });
                const area = document.getElementById('college-list-area'); area.innerHTML = "";
                if(loggedInRole === 'super') Array.from(colls).forEach(c => area.innerHTML += `<div class="list-item" onclick="showStudentsNav('${c}')">üìÅ College: ${c}</div>`);
                else showStudentsNav(loggedInCollege);
            });
        }

        function showStudentsNav(c) {
            document.getElementById('view-colleges').classList.add('hidden'); document.getElementById('view-students').classList.remove('hidden'); document.getElementById('view-details').classList.add('hidden');
            const area = document.getElementById('student-list-area'); area.innerHTML = "";
            allUsers.filter(u => u.collegeId === c && (u.role === 'student' || u.role === 'faculty')).forEach(u => area.innerHTML += `<div class="list-item" onclick="showDetails('${u.id}')">üë§ ${u.fullName} (${u.studentId})</div>`);
        }

        async function showDetails(uid) {
            const u = allUsers.find(x => x.id === uid); if(!u) return; currentStudentName = u.fullName;
            document.getElementById('view-students').classList.add('hidden'); document.getElementById('view-details').classList.remove('hidden');
            document.getElementById('det-name').innerText = u.fullName;
            const logArea = document.getElementById('det-logs'); logArea.innerHTML = "Loading logs...";
            db.collection("activity_logs").where("userId","==",uid).orderBy("startTime","desc").onSnapshot(snap => {
                logArea.innerHTML = ""; currentLogs = []; let usage = 0; let readPrev = 0; let readFull = 0;
                snap.forEach(doc => {
                    const l = doc.data(); const d = l.endTime ? Math.round((l.endTime - l.startTime)/1000) : 0;
                    currentLogs.push({ ...l, duration: d });
                    if(l.type === "Usage") usage += d; if(l.type === "Online Read") readPrev += d; if(l.type === "Full Read") readFull += d;
                    logArea.innerHTML += `<div style="padding:4px; border-bottom:1px solid #334155; display:flex; justify-content:space-between;"><span>${l.type}: ${l.activity}</span><span>${formatTime(d)}</span></div>`;
                });
                document.getElementById('sum-usage').innerHTML = `Usage: <b>${formatTime(usage)}</b>`;
                document.getElementById('sum-read').innerHTML = `Preview: <b>${formatTime(readPrev)}</b> | Full: <b>${formatTime(readFull)}</b>`;
            });
        }

        async function downloadStudentCSV() { if(currentLogs.length === 0) return alert("No logs to download"); let csv = "Type,Activity,Start Time,End Time,Duration(s)\n"; currentLogs.forEach(l => { csv += `${l.type},${l.activity},${new Date(l.startTime).toLocaleString()},${l.endTime ? new Date(l.endTime).toLocaleString() : 'Active'},${l.duration}\n`; }); const link = document.createElement("a"); link.href = "data:text/csv;charset=utf-8," + encodeURI(csv); link.download = `${currentStudentName}_Logs.csv`; link.click(); }
        function formatTime(s) { const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60; return `${h}h ${m}m ${sec}s`; }
        function showCollegesNav() { document.getElementById('view-colleges').classList.remove('hidden'); document.getElementById('view-students').classList.add('hidden'); }
        function showStudentsNav() { document.getElementById('view-students').classList.remove('hidden'); document.getElementById('view-details').classList.add('hidden'); }
        function loadInbox() { const q = loggedInRole === 'super' ? db.collection("admin_messages") : db.collection("admin_messages").where("college","==",loggedInCollege); q.orderBy("date","desc").onSnapshot(snap => { const area = document.getElementById('inbox-area'); area.innerHTML = ""; snap.forEach(doc => { const m = doc.data(); area.innerHTML += `<div class="inbox-msg"><span class="msg-del" onclick="deleteMsg('${doc.id}')">√ó</span><b>${m.type}</b>: ${m.message || m.book}<br><small>${m.user} (${m.college})</small></div>`; }); }); }
        async function deleteMsg(id) { if(confirm("Delete?")) await db.collection("admin_messages").doc(id).delete(); }
    </script>
</body>
</html>
