<script>
const firebaseConfig = {
  apiKey: "AIzaSyBBZ5Yvd7XH4lymNq2vIp-cwxPba55upWg",
  authDomain: "student-library-4a4e7.firebaseapp.com",
  projectId: "student-library-4a4e7",
  storageBucket: "student-library-4a4e7.firebasestorage.app",
  messagingSenderId: "827419448917",
  appId: "1:827419448917:web:4b0d1084e6f1fe1b2566dc"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const auth = firebase.auth();

let allBooks = [];
let currentUser = null;
let sessionStart = null;
let readStart = null;
let readTask = "";

/* SAFE CLOCK */
setInterval(() => {
    const c = document.getElementById('clock');
    if(c) c.innerText = new Date().toLocaleTimeString();
}, 1000);

/* =========================
   GOOGLE LOGIN (REDIRECT)
   NO POPUP BLOCKER ISSUES
   ========================= */
async function handleLogin() {
    const provider = new firebase.auth.GoogleAuthProvider();
    const s = document.getElementById('login-status');
    if(s) s.innerText = "Redirecting to Google login...";
    await auth.signInWithRedirect(provider);
}

/* HANDLE REDIRECT ERRORS */
auth.getRedirectResult().catch(err => {
    console.error("Redirect Error:", err);
    const s = document.getElementById('login-status');
    if(s) s.innerText = "Login failed. Please try again.";
});

/* AUTH STATE */
auth.onAuthStateChanged(user => {
    if(user) {
        currentUser = user;
        sessionStart = Date.now();

        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('p-name').innerText = user.displayName || "User";

        loadLib();
        listenBorrows();
        logAct("App Opened");
    } else {
        document.getElementById('auth-screen').classList.remove('hidden');
        document.getElementById('dashboard').classList.add('hidden');
    }
});

/* ACTIVITY LOG */
function logAct(type, dur = "0s") {
    if(!currentUser) return;
    db.collection("activity_logs").add({ 
        userId: currentUser.uid,
        activityType: type,
        duration: dur,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
}

/* PDF READER */
function openPdf(id, s, task) {
    readStart = Date.now();
    readTask = task;
    document.getElementById('pdf-frame').src = `public/${id}${s}.pdf#toolbar=0`;
    document.getElementById('reader-overlay').classList.remove('hidden');
}

function closeReader() {
    if(readStart){
        const dur = Math.round((Date.now() - readStart)/1000) + "s";
        logAct(readTask, dur);
    }
    document.getElementById('reader-overlay').classList.add('hidden');
    document.getElementById('pdf-frame').src = "";
}

/* RENDER BOOK */
function renderB(id, t) {
    return `
    <div class="book-item">
        <div class="sliding-container">
            <span class="sliding-text">${t || id}</span>
        </div>
        <div style="display:flex; gap:5px;">
            <button class="btn-blue" onclick="openPdf('${id}', '_read_online', 'Read Online')">Preview</button>
            <button class="btn-blue" style="background:#eee;color:#333;" onclick="borrowB('${id}', '${t}')">Borrow</button>
        </div>
    </div>`;
}

/* LOAD LIBRARY */
function loadLib() {
    db.collection("library_settings").onSnapshot(snap => {
        const rL = document.getElementById('recent-list');
        const tL = document.getElementById('trending-list');
        rL.innerHTML = ""; 
        tL.innerHTML = ""; 
        allBooks = [];

        snap.forEach(doc => {
            const b = doc.data();
            allBooks.push({id: doc.id, ...b});
            if(b.recent) rL.innerHTML += renderB(doc.id, b.title);
            if(b.trending) tL.innerHTML += renderB(doc.id, b.title);
        });
    });
}

/* SEARCH FIX (OPEN BOOK DIRECTLY) */
function handleSuggest(q) {
    const list = document.getElementById('suggest-list');
    if (q.length < 2) { list.style.display = "none"; return; }

    const filtered = allBooks.filter(b => 
        (b.title||'').toLowerCase().includes(q.toLowerCase())
    );

    list.innerHTML = "";
    if (filtered.length > 0) {
        list.style.display = "block";
        filtered.forEach(b => {
            const d = document.createElement('div');
            d.className = 'suggest-item';
            d.innerText = b.title;
            d.onclick = () => {
                openPdf(b.id, '_read_online', 'Search Read');
                list.style.display = "none";
            };
            list.appendChild(d);
        });
    }
}

/* CATEGORY */
async function loadCat(n) {
    if(!n) return;

    document.getElementById('cat-name').innerText = n;
    document.getElementById('cat-view').classList.remove('hidden');

    const snap = await db.collection("library_settings")
        .where("category", "==", n.trim())
        .get();

    const l = document.getElementById('cat-list'); 
    l.innerHTML = "";
    snap.forEach(doc => {
        l.innerHTML += renderB(doc.id, doc.data().title);
    });
}

/* BORROWS */
function listenBorrows() {
    db.collection("borrows")
      .where("userId", "==", currentUser.uid)
      .onSnapshot(snap => {
        const list = document.getElementById('borrowed-list');
        list.innerHTML = snap.empty ? "No borrowed books." : "";

        snap.forEach(doc => {
            const b = doc.data();
            const days = 7 - Math.ceil(
                Math.abs(new Date() - new Date(b.borrowedAt)) / (1000*60*60*24)
            );

            list.innerHTML += `
            <div class="book-item">
                <span><b>${b.title}</b> (${days} days left)</span>
                <div style="display:flex; gap:5px;">
                    <button class="btn-blue" onclick="openPdf('${b.bookId}', '', 'Borrowed Reading')">Open</button>
                    <button class="btn-blue" style="background:#ef4444" onclick="db.collection('borrows').doc('${doc.id}').delete()">Return</button>
                </div>
            </div>`;
        });
    });
}

/* BORROW */
async function borrowB(id, t) {
    const code = prompt("Enter borrow code:");
    if(code !== "BORROW2026") {
        alert("Invalid borrow code");
        return;
    }

    await db.collection("borrows").add({
        userId: currentUser.uid,
        bookId: id,
        title: t,
        borrowedAt: new Date().toISOString()
    });
}

/* TABS (ACTIVE FIX) */
function switchMainTab(t) {
    document.getElementById('lib-view').classList.toggle('hidden', t !== 'lib');
    document.getElementById('prof-view').classList.toggle('hidden', t !== 'prof');

    document.getElementById('t-lib').classList.toggle('active', t === 'lib');
    document.getElementById('t-prof').classList.toggle('active', t === 'prof');
}

/* LOGOUT */
function logout() {
    const dur = Math.round((Date.now() - sessionStart)/1000) + "s";
    logAct("App Closed", dur);
    auth.signOut().then(() => location.reload());
}
</script>
